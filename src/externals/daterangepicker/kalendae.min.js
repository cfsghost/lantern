/********************************************************************
 *	Kalendae, a framework agnostic javascript date picker           *
 *	Copyright(c) 2013 Jarvis Badgley (chipersoft@gmail.com)         *
 *	http://github.com/ChiperSoft/Kalendae                           *
 *	Version 0.5.5                                                   *
 ********************************************************************/

(function(z){var q,l,n=function(a,b){if("function"===typeof document.addEventListener||e.isIE8()){var c=!1;try{c=a instanceof Element}catch(n){c=!!a&&1===c.nodeType}c||"string"===typeof a||(b=a);var d=this,g=d.classes,f=d.settings=e.merge(d.defaults,{attachTo:a},b||{}),c=d.container=e.make("div",{"class":g.container}),h=d.calendars=[],t=l().day(f.weekStart),m,r=[],p,k,q,v;p=[];var w;k=0;m=f.months;e.isIE8()&&e.addClassName(c,"ie8");for(k=7;k--;)r.push(t.format(f.columnHeaderFormat)),t.add(1,"days");
y(d);if("object"===typeof f.subscribe)for(k in f.subscribe)f.subscribe.hasOwnProperty(k)&&d.subscribe(k,f.subscribe[k]);m=f.viewStartDate?l(f.viewStartDate,f.format):l();d.viewStartDate=m.date(1);d._sel=[];f.selected&&(d.setSelected(f.selected,!1),d.viewStartDate=l(d._sel[0]));(m={past:f.months-1,"today-past":f.months-1,any:2<f.months?Math.floor(f.months/2):0,"today-future":0,future:0}[this.settings.direction])&&l().month()==l(d.viewStartDate).month()&&(d.viewStartDate=l(d.viewStartDate).subtract({M:m}).date(1));
d.defaultView=l(d.viewStartDate);if("function"===typeof f.blackout)d.blackout=f.blackout;else if(f.blackout){var x=u(f.blackout,f.parseSplitDelimiter,f.format);d.blackout=function(a){a=l(a).startOf("day").yearDay();if(1>a||!d._sel)return!1;for(var c=x.length;c--;)if(x[c].startOf("day").yearDay()===a)return!0;return!1}}else d.blackout=function(){return!1};d.direction=d.directions[f.direction]?d.directions[f.direction]:d.directions.any;for(m=Math.max(f.months,1);m--;){p=e.make("div",{"class":g.calendar},
c);p.setAttribute("data-cal-index",m);1<f.months&&(m==Math.max(f.months-1,1)?e.addClassName(p,g.monthFirst):0===m?e.addClassName(p,g.monthLast):e.addClassName(p,g.monthMiddle));k=e.make("div",{"class":g.title},p);f.useYearNav||e.addClassName(k,g.disableYearNav);e.make("a",{"class":g.previousYear},k);e.make("a",{"class":g.previousMonth},k);e.make("a",{"class":g.nextYear},k);e.make("a",{"class":g.nextMonth},k);t=e.make("span",{"class":g.caption},k);q=e.make("div",{"class":g.header},p);k=0;do w=e.make("span",
{},q),w.innerHTML=r[k];while(7>++k);q=e.make("div",{"class":g.days},p);k=0;p=[];do"week"==f.mode?(0===k%7&&(v=e.make("div",{"class":g.week+" clearfix"},q),p.push(v)),e.make("span",{},v)):p.push(e.make("span",{},q));while(42>++k);h.push({caption:t,days:p});m&&e.make("div",{"class":g.monthSeparator},c)}d.draw();e.addEvent(c,"mousedown",function(a,c){var b;if(e.hasClassName(c,g.nextMonth))d.disableNext||!1===d.publish("view-changed",d,["next-month"])||(d.viewStartDate.add(1,"months"),d.draw());else if(e.hasClassName(c,
g.previousMonth))d.disablePreviousMonth||!1===d.publish("view-changed",d,["previous-month"])||(d.viewStartDate.subtract(1,"months"),d.draw());else if(e.hasClassName(c,g.nextYear))d.disableNext||!1===d.publish("view-changed",d,["next-year"])||(d.viewStartDate.add(1,"years"),d.draw());else if(e.hasClassName(c,g.previousYear))d.disablePreviousMonth||!1===d.publish("view-changed",d,["previous-year"])||(d.viewStartDate.subtract(1,"years"),d.draw());else if((e.hasClassName(c.parentNode,g.days)||e.hasClassName(c.parentNode,
g.week))&&e.hasClassName(c,g.dayActive)&&(b=c.getAttribute("data-date"))){if(b=l(b,f.dayAttributeFormat).hours(12),!1!==d.publish("date-clicked",d,[b]))switch(f.mode){case "multiple":d.addSelected(b)||d.removeSelected(b);break;case "range":d.addSelected(b);break;case "week":d.weekSelected(b);break;default:d.addSelected(b)}}else e.hasClassName(c.parentNode,g.week)&&(b=c.getAttribute("data-date"))&&(b=l(b,f.dayAttributeFormat).hours(12),!1!==d.publish("date-clicked",d,[b])&&"week"==f.mode&&d.weekSelected(b));
return!1});(f.attachTo=e.$(f.attachTo))&&f.attachTo.appendChild(c)}};n.prototype={defaults:{attachTo:null,months:1,weekStart:0,direction:"any",directionScrolling:!0,viewStartDate:null,blackout:null,selected:null,mode:"single",dayOutOfMonthClickable:!1,format:null,subscribe:null,columnHeaderFormat:"dd",titleFormat:"MMMM, YYYY",dayNumberFormat:"D",dayAttributeFormat:"YYYY-MM-DD",parseSplitDelimiter:/,\s*|\s+-\s+/,rangeDelimiter:" - ",multipleDelimiter:", ",useYearNav:!0,dateClassMap:{}},classes:{container:"kalendae",
calendar:"k-calendar",monthFirst:"k-first-month",monthMiddle:"k-middle-month",monthLast:"k-last-month",title:"k-title",previousMonth:"k-btn-previous-month",nextMonth:"k-btn-next-month",previousYear:"k-btn-previous-year",nextYear:"k-btn-next-year",caption:"k-caption",header:"k-header",days:"k-days",week:"k-week",dayOutOfMonth:"k-out-of-month",dayInMonth:"k-in-month",dayActive:"k-active",daySelected:"k-selected",dayInRange:"k-range",dayToday:"k-today",monthSeparator:"k-separator",disablePreviousMonth:"k-disable-previous-month-btn",
disableNextMonth:"k-disable-next-month-btn",disablePreviousYear:"k-disable-previous-year-btn",disableNextYear:"k-disable-next-year-btn",disableYearNav:"k-disable-year-nav"},disablePreviousMonth:!1,disableNextMonth:!1,disablePreviousYear:!1,disableNextYear:!1,directions:{past:function(a){return l(a).startOf("day").yearDay()>=q.yearDay()},"today-past":function(a){return l(a).startOf("day").yearDay()>q.yearDay()},any:function(a){return!1},"today-future":function(a){return l(a).startOf("day").yearDay()<
q.yearDay()},future:function(a){return l(a).startOf("day").yearDay()<=q.yearDay()}},getSelectedAsDates:function(){for(var a=[],b=0,c=this._sel.length;b<c;b++)a.push(this._sel[b].toDate());return a},getSelectedAsText:function(a){for(var b=[],c=0,d=this._sel.length;c<d;c++)b.push(this._sel[c].format(a||this.settings.format||"YYYY-MM-DD"));return b},getSelectedRaw:function(){for(var a=[],b=0,c=this._sel.length;b<c;b++)a.push(l(this._sel[b]));return a},getSelected:function(a){a=this.getSelectedAsText(a);
switch(this.settings.mode){case "week":case "range":return a.splice(2),a.join(this.settings.rangeDelimiter);case "multiple":return a.join(this.settings.multipleDelimiter);default:return a[0]||null}},isSelected:function(a){a=l(a).startOf("day").yearDay();if(1>a||!this._sel||1>this._sel.length)return!1;switch(this.settings.mode){case "week":case "range":var b=this._sel[0]?this._sel[0].startOf("day").yearDay():0,c=this._sel[1]?this._sel[1].startOf("day").yearDay():0;return b===a||c===a?1:b&&c?a>b&&a<
c||b<c&&a<b&&a>c?-1:!1:0;case "multiple":for(b=this._sel.length;b--;)if(this._sel[b].startOf("day").yearDay()===a)return!0;return!1;default:return this._sel[0]&&this._sel[0].startOf("day").yearDay()===a}},setSelected:function(a,b){var c,d=u(a,this.settings.parseSplitDelimiter,this.settings.format),g=u(this.getSelected(),this.settings.parseSplitDelimiter,this.settings.format);for(c=g.length;c--;)this.removeSelected(g[c],!1);for(c=d.length;c--;)this.addSelected(d[c],!1);!1!==b&&(d[0]&&(this.viewStartDate=
l(d[0],this.settings.format)),this.draw())},addSelected:function(a,b){a=l(a,this.settings.format).hours(12);this.settings.dayOutOfMonthClickable&&"range"!==this.settings.mode&&this.makeSelectedDateVisible(a);switch(this.settings.mode){case "multiple":if(this.isSelected(a))return!1;this._sel.push(a);break;case "range":1!==this._sel.length?this._sel=[a]:a.startOf("day").yearDay()>this._sel[0].startOf("day").yearDay()?this._sel[1]=a:this._sel=[a,this._sel[0]];break;default:this._sel=[a]}this._sel.sort(function(a,
b){return a.startOf("day").yearDay()-b.startOf("day").yearDay()});this.publish("change",this,[a]);!1!==b&&this.draw();return!0},weekSelected:function(a){var b=a.toDate(),c=l(b).startOf("week"),b=l(b).endOf("week").subtract(1,"day");this._sel=[c,b];this.publish("change",this,[a.day()]);this.draw()},makeSelectedDateVisible:function(a){outOfViewMonth=l(a).date("1").diff(this.viewStartDate,"months");0>outOfViewMonth?this.viewStartDate.subtract(1,"months"):0<outOfViewMonth&&outOfViewMonth>=this.settings.months&&
this.viewStartDate.add(1,"months")},removeSelected:function(a,b){a=l(a,this.settings.format).hours(12);for(var c=this._sel.length;c--;)if(this._sel[c].startOf("day").yearDay()===a.startOf("day").yearDay())return this._sel.splice(c,1),this.publish("change",this,[a]),!1!==b&&this.draw(),!0;return!1},draw:function(){var a=l(this.viewStartDate).startOf("day").add(12,"hours"),b,c=this.classes,d,g,f,h=0,n,m=0,r,p,k=this.settings;n=this.calendars.length;do{b=l(a).date(1);b.day(b.day()<this.settings.weekStart?
this.settings.weekStart-7:this.settings.weekStart);d=this.calendars[h];d.caption.innerHTML=a.format(this.settings.titleFormat);r=m=0;do"week"==k.mode?(0===m%7&&0!==m&&r++,g=d.days[r].childNodes[m%7]):g=d.days[m],f=[],(p=this.isSelected(b))&&f.push({"-1":c.dayInRange,1:c.daySelected,"true":c.daySelected}[p]),b.month()!=a.month()?f.push(c.dayOutOfMonth):f.push(c.dayInMonth),(!(this.blackout(b)||this.direction(b)||b.month()!=a.month()&&!1===k.dayOutOfMonthClickable)||0<p)&&f.push(c.dayActive),b.clone().startOf("day").yearDay()===
q.yearDay()&&f.push(c.dayToday),p=b.format(this.settings.dayAttributeFormat),k.dateClassMap[p]&&f.push(k.dateClassMap[p]),g.innerHTML=b.format(k.dayNumberFormat),g.className=f.join(" "),g.setAttribute("data-date",p),b.add(1,"days");while(42>++m);a.add(1,"months")}while(++h<n);if(k.directionScrolling){b=l().startOf("day").hours(12);a=a.diff(b,"months",!0);if("today-past"===k.direction||"past"===k.direction)0>=a?(this.disableNextMonth=!1,e.removeClassName(this.container,c.disableNextMonth)):(this.disableNextMonth=
!0,e.addClassName(this.container,c.disableNextMonth));else if("today-future"===k.direction||"future"===k.direction)a>k.months?(this.disablePreviousMonth=!1,e.removeClassName(this.container,c.disablePreviousMonth)):(this.disablePreviousMonth=!0,e.addClassName(this.container,c.disablePreviousMonth));if("today-past"===k.direction||"past"===k.direction)-11>=a?(this.disableNextYear=!1,e.removeClassName(this.container,c.disableNextYear)):(this.disableNextYear=!0,e.addClassName(this.container,c.disableNextYear));
else if("today-future"===k.direction||"future"===k.direction)a>11+k.months?(this.disablePreviousYear=!1,e.removeClassName(this.container,c.disablePreviousYear)):(this.disablePreviousYear=!0,e.addClassName(this.container,c.disablePreviousYear))}}};var u=function(a,b,c){var d=[];"string"===typeof a?a=a.split(b):e.isArray(a)||(a=[a]);b=a.length;var g=0,f;do a[g]&&(f=l(a[g],c).hours(12),f.isValid()&&d.push(f));while(++g<b);return d};window.Kalendae=n;var e=n.util={isIE8:function(){return!(!/msie 8./i.test(navigator.appVersion)||
/opera/i.test(navigator.userAgent)||!window.ActiveXObject||!XDomainRequest||window.msPerformance)},$:function(a){return"string"==typeof a?document.getElementById(a):a},$$:function(a){return document.querySelectorAll(a)},make:function(a,b,c){var d;a=document.createElement(a);if(b)for(d in b)b.hasOwnProperty(d)&&a.setAttribute(d,b[d]);c&&c.appendChild(a);return a},isVisible:function(a){return 0<a.offsetWidth||0<a.offsetHeight},getStyle:function(a,b){var c;a.currentStyle?c=a.currentStyle[b]:window.getComputedStyle&&
(c=(c=window.getComputedStyle(a,null))?c[b]:"");return c},domReady:function(a){var b=document.readyState;"complete"===b||"interactive"===b?a():setTimeout(function(){e.domReady(a)},9)},addEvent:function(a,b,c){var d=function(b){b=b||window.event;var d=c.apply(a,[b,b.target||b.srcElement]);!1===d&&(b.preventDefault?b.preventDefault():(b.returnValue=!1,b.cancelBubble=!0));return d};a.attachEvent?a.attachEvent("on"+b,d):a.addEventListener(b,d,!1);return d},removeEvent:function(a,b,c){a.detachEvent?a.detachEvent("on"+
b,c):a.removeEventListener(b,c,!1)},fireEvent:function(a,b){if(document.createEvent){var c=document.createEvent("HTMLEvents");c.initEvent(b,!0,!0);a.dispatchEvent(c)}else if(document.createEventObject)a.fireEvent("on"+b);else if("function"==typeof a["on"+b])a["on"+b]()},hasClassName:function(a,b){if(!(a=e.$(a)))return!1;var c=a.className;return 0<c.length&&(c==b||(new RegExp("(^|\\s)"+b+"(\\s|$)")).test(c))},addClassName:function(a,b){(a=e.$(a))&&!e.hasClassName(a,b)&&(a.className+=(a.className?" ":
"")+b)},removeClassName:function(a,b){if(a=e.$(a))a.className=e.trimString(a.className.replace(new RegExp("(^|\\s+)"+b+"(\\s+|$)")," "))},isFixed:function(a){do if("fixed"===e.getStyle(a,"position"))return!0;while(a=a.offsetParent);return!1},scrollContainer:function(a){do{var b=e.getStyle(a,"overflow");if("auto"===b||"scroll"===b)return a}while((a=a.parentNode)&&a!=window.document.body);return null},getPosition:function(a,b){var c=a.offsetLeft,d=a.offsetTop,e={};if(!b)for(;a=a.offsetParent;)c+=a.offsetLeft,
d+=a.offsetTop;e[0]=e.left=c;e[1]=e.top=d;return e},getHeight:function(a){return a.offsetHeight||a.scrollHeight},getWidth:function(a){return a.offsetWidth||a.scrollWidth},trimString:function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},merge:function(){for(var a=!0===arguments[0],b={},c=a?1:0;c<arguments.length;c++){var d=b,e=arguments[c];if("object"===typeof e){var f=void 0;for(f in e)e.hasOwnProperty(f)&&(a&&"object"===typeof d[f]&&"object"===typeof e[f]?_update(d[f],e[f]):d[f]=e[f])}}return b},
isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)}};"function"===typeof document.addEventListener&&n.util.domReady(function(){for(var a=e.$$(".auto-kal"),b=a.length,c,d;b--;)c=a[b],d=c.getAttribute("data-kal"),d=null==d||""==d?{}:(new Function("return {"+d+"};"))(),"INPUT"===c.tagName?new n.Input(c,d):new n(e.merge(d,{attachTo:c}))});n.Input=function(a,b){if("function"===typeof document.addEventListener||e.isIE8()){var c=this.input=e.$(a),d,g,f=!1;if(!c||"INPUT"!==c.tagName)throw"First argument for Kalendae.Input must be an <input> element or a valid element id.";
var h=this,q=h.classes;g=h.settings=e.merge(h.defaults,b);this._events={};g.attachTo=window.document.body;g.selected?d=!0:g.selected=c.value;n.call(h,g);g.closeButton&&(g=e.make("a",{"class":q.closeButton},h.container),e.addEvent(g,"click",function(){c.blur()}));d&&(c.value=h.getSelected());d=h.container;var m=!1;d.style.display="none";e.addClassName(d,q.positioned);this._events.containerMouseDown=e.addEvent(d,"mousedown",function(a,b){m=!0});this._events.documentMousedown=e.addEvent(window.document,
"mousedown",function(a,b){m=!1});this._events.inputFocus=e.addEvent(c,"focus",function(){f=!0;h.setSelected(this.value);f=!1;h.show()});this._events.inputBlur=e.addEvent(c,"blur",function(){m&&e.isIE8()?(m=!1,c.focus()):h.hide()});this._events.inputKeyup=e.addEvent(c,"keyup",function(a){f=!0;(a=u(this.value,h.settings.parseSplitDelimiter,h.settings.format))&&a.length&&a[0]&&1E3<a[0].year()?h.setSelected(this.value):(h.setSelected("",null),h.viewStartDate=l(h.defaultView),h.draw());f=!1});(q=e.scrollContainer(c))&&
e.addEvent(q,"scroll",function(a){c.blur()});h.subscribe("change",function(){f||(c.value=h.getSelected(),e.fireEvent(c,"change"))})}};n.Input.prototype=e.merge(n.prototype,{defaults:e.merge(n.prototype.defaults,{format:"MM/DD/YYYY",side:"bottom",closeButton:!0,offsetLeft:0,offsetTop:0}),classes:e.merge(n.prototype.classes,{positioned:"k-floating",closeButton:"k-btn-close"}),show:function(){var a=this.container,b=a.style,c=this.input,d=e.getPosition(c),g=e.scrollContainer(c),f=g?g.scrollTop:0,g=g?
g.scrollLeft:0,h=this.settings;b.display="";switch(h.side){case "left":b.left=d.left-e.getWidth(a)+h.offsetLeft-g+"px";b.top=d.top+h.offsetTop-f+"px";break;case "right":b.left=d.left+e.getWidth(c)-g+"px";b.top=d.top+h.offsetTop-f+"px";break;case "top":b.left=d.left+h.offsetLeft-g+"px";b.top=d.top-e.getHeight(a)+h.offsetTop-f+"px";break;case "bottom right":b.left=d.left-e.getWidth(a)+e.getWidth(c)+h.offsetLeft+"px";b.top=d.top+e.getHeight(c)+h.offsetTop-f+"px";break;default:b.left=d.left+h.offsetLeft-
g+"px",b.top=d.top+e.getHeight(c)+h.offsetTop-f+"px"}b.position=e.isFixed(c)?"fixed":"absolute";this.publish("show",this)},hide:function(){this.container.style.display="none";this.publish("hide",this)},destroy:function(){var a=this.container,b=this.input;e.removeEvent(a,"mousedown",this._events.containerMousedown);e.removeEvent(window.document,"mousedown",this._events.documentMousedown);e.removeEvent(b,"focus",this._events.inputFocus);e.removeEvent(b,"blur",this._events.inputBlur);e.removeEvent(b,
"keyup",this._events.inputKeyup);a.remove()}});var y=function(a){a||(a=this);var b=a.c_||{};a.publish=function(a,d,e){for(var f=(a=b[a])?a.length:0,h;f--;)if(h=a[f].apply(d,e||[]),"boolean"===typeof h)return h};a.subscribe=function(a,d,e){b[a]||(b[a]=[]);e?b[a].push(d):b[a].unshift(d);return[a,d]};a.unsubscribe=function(a){var d=b[a[0]];a=a[1];for(var e=d?d.length:0;e--;)d[e]===a&&d.splice(e,1)}};if(!n.moment)if(window.moment)n.moment=window.moment;else throw"Kalendae requires moment.js. You must use kalendae.standalone.js if moment is not available on the page.";
l=n.moment;l.fn.yearDay=function(a){var b=Math.floor(this._d/864E5);return"undefined"===typeof a?b:this.add({d:a-b})};q=n.moment().startOf("day");"undefined"===typeof jQuery||"function"!==typeof document.addEventListener&&!e.isIE8()||(jQuery.fn.kalendae=function(a){this.each(function(b,c){"INPUT"===c.tagName?jQuery(c).data("kalendae",new n.Input(c,a)):jQuery(c).data("kalendae",new n(jQuery.extend({},{attachTo:c},a)))});return this})})();
